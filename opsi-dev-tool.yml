project:
  name: opsi-server
  version: 4.2.0.15
  description: opsi server
  homepage: http://www.opsi.org
  licenses:
    - license: AGPL-3.0
  maintainer: uib GmbH <info@uib.de>

package:
  name: opsi-server
  type: binary
  architecture: all
  depends:
    - opsiconfd (>= 4.2)
    - opsipxeconfd (>= 4.2)
    - opsi-linux-bootimage (>= 20200824)
    - opsi-tftpd
    - opsi-utils (>= 4.2)
    - samba
    - sudo
    - wget
  suggests:
    - mysql-server
    - redis-server (>= 5.0)
    - redis-timeseries
    - opsi-windows-support
    - opsi-linux-support
  provides:
    - opsi-depotserver (= 4.2)
  breaks:
    - opsi-depotserver (<< 4.1)
  conflicts:
    - opsi-server-expert
    - opsi-server-full
    - python-opsi (<< 4.2)
  replaces:
    - opsi-depotserver (<< 4.1)
  source_script: |
    mkdir -p "${DST}/rootfs/var/lib/opsi/depot"
    mkdir -p "${DST}/rootfs/var/lib/opsi/ntfs-images"
    mkdir -p "${DST}/rootfs/var/lib/opsi/repository"
    mkdir -p "${DST}/rootfs/var/lib/opsi/workbench"
    mkdir -p "${DST}/rootfs/var/log/opsi/bootimage"
    mkdir -p "${DST}/rootfs/var/log/opsi/clientconnect"
    mkdir -p "${DST}/rootfs/var/log/opsi/instlog"
    mkdir -p "${DST}/rootfs/var/log/opsi/userlogin"
    mkdir -p "${DST}/rootfs/etc"
    cp -a "${SRC}/opsi-server_data/etc" "${DST}/rootfs/etc/opsi"
  postinst_script: |
    if grep "^fileadmingroup *= *opsifileadmins$" /etc/opsi/opsi.conf >/dev/null; then
      if ! getent group opsifileadmins >/dev/null; then
        if getent group pcpatch >/dev/null; then
          sed -i s"/^fileadmingroup.*/fileadmingroup = pcpatch/" /etc/opsi/opsi.conf
        fi
      fi
    fi
    [ -e /var/lib/opsi/server_commands_custom.conf ] || touch /var/lib/opsi/server_commands_custom.conf
    # Removing files dating before opsi 4.1
    [ -e /etc/opsi/version ] && rm /etc/opsi/version
    # Setup
    /usr/bin/opsiconfd setup --log-level-stderr=5 --log-level-file=0 || true
    opsi-setup --set-rights /var/lib/opsi/server_commands_custom.conf || true
    opsi-setup --set-rights /etc || true
  subpackages:
    - name: expert
      depends:
        - opsiconfd (>= 4.2)
        - opsipxeconfd (>= 4.2)
        - opsi-linux-bootimage (>= 20200824)
        - opsi-tftpd
        - opsi-utils (>= 4.2)
      provides:
        - opsi-server (= 4.2)
      conflicts:
        - opsi-server
        - opsi-server-full
        - python-opsi (<< 4.2)
      replaces:
        - opsi-depotserver-expert
    - name: full
      depends:
        - opsiconfd (>= 4.2)
        - opsipxeconfd (>= 4.2)
        - opsi-linux-bootimage (>= 20200824)
        - opsi-tftpd
        - opsi-utils (>= 4.2)
        - samba
        - sudo
        - wget
        - mysql-server | mariadb-server
        - redis-server (>= 5.0)
        - redis-timeseries
        - opsi-windows-support
        - opsi-linux-support
        - grafana
      provides:
        - opsi-server (= 4.2)
      conflicts:
        - opsi-server
        - opsi-server-expert
        - python-opsi (<< 4.2)
